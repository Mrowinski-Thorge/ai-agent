<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal AI Agent</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        :root { --footer-height: 230px; }
        html, body { height: 100%; margin: 0; overflow: hidden; }
        body { display: flex; flex-direction: column; }

        main {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            padding-bottom: var(--footer-height);
            width: 100%;
            max-width: 960px;
            margin: 0 auto;
        }

        #start-view { display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; height: 100%; }
        #chat-log { display: none; }
        .chat-message { padding: 1.2rem; margin-bottom: 1rem; border-radius: var(--pico-border-radius); }
        .ai-message { background-color: var(--pico-card-background-color); }
        .message-header { font-weight: bold; margin-bottom: 0.5rem; }
        .ai-message pre { white-space: pre-wrap; word-wrap: break-word; background-color: #1a1a1a; padding: 1rem; border-radius: var(--pico-border-radius); }
        .thinking-cursor { display: inline-block; width: 10px; height: 1.2em; background-color: var(--pico-primary); animation: blink 1s step-end infinite; vertical-align: text-bottom; }
        @keyframes blink { from, to { background-color: transparent; } 50% { background-color: var(--pico-primary); } }
        .error-message { color: var(--pico-form-element-invalid-active-border-color); background-color: rgba(255, 82, 82, 0.1); border: 1px solid; padding: 1rem; border-radius: var(--pico-border-radius); }

        footer { position: fixed; bottom: 0; left: 0; right: 0; background: var(--pico-background-color); border-top: 1px solid var(--pico-card-border-color); padding: 1rem; z-index: 100; }
        #form-container { max-width: 960px; margin: 0 auto; }
        #manual-controls { border: 1px solid var(--pico-card-border-color); padding: 1rem; border-radius: var(--pico-border-radius); margin-bottom: 1rem; }
    </style>
</head>
<body>

    <dialog id="password-modal">
        <article>
            <header><h3>Zugangspasswort</h3></header>
            <form id="password-form">
                <input type="password" id="password-input" required placeholder="Passwort eingeben...">
                <button type="submit">Bestätigen</button>
            </form>
        </article>
    </dialog>

    <main id="main-content">
        <div id="start-view">
            <h1>Neo AI Agent</h1>
            <p>Ihr Assistent für Recherche, Code und Präsentationen.</p>
        </div>
        <div id="chat-log"></div>
    </main>

    <footer>
        <div id="form-container">
            <form id="agent-form">
                <div id="manual-controls" hidden>
                    <div class="grid">
                        <fieldset>
                            <legend>Werkzeuge</legend>
                            <label><input type="checkbox" id="websuche" name="websuche"> Websuche</label>
                            <label><input type="checkbox" id="code-interpreter" name="code-interpreter"> Code Interpreter</label>
                        </fieldset>
                        <div>
                            <label for="model">Modell</label>
                            <!-- KORREKTUR: Modellauswahl angepasst -->
                            <select id="model" name="model">
                                <option value="llama-3.3-70b-versatile">Llama 3.3 70B (Stark)</option>
                                <option value="llama-3.1-8b-instant" selected>Llama 3.1 8B (Schnell)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <textarea id="prompt" name="prompt" rows="1" placeholder="Ihre Anfrage..." required></textarea>
                <div class="grid">
                    <fieldset>
                        <legend>Modus</legend>
                        <label><input type="radio" name="mode" value="automatic" checked> Auto</label>
                        <label><input type="radio" name="mode" value="manual"> Manuell</label>
                    </fieldset>
                    <div>
                        <label for="output_format">Ausgabe</label>
                        <select id="output_format" name="output_format">
                            <option value="text" selected>Text</option>
                            <option value="powerpoint">PowerPoint</option>
                            <option value="code">Code</option>
                        </select>
                    </div>
                    <button type="submit" id="submit-button">Senden</button>
                </div>
            </form>
        </div>
    </footer>

    <script>
        // Das gesamte JavaScript aus der vorherigen Version kann hier 1:1 übernommen werden.
        // Es ist bereits korrekt und robust.
        const passwordModal = document.getElementById('password-modal');
        const passwordForm = document.getElementById('password-form');
        const agentForm = document.getElementById('agent-form');
        const manualControls = document.getElementById('manual-controls');
        const promptInput = document.getElementById('prompt');
        const chatLog = document.getElementById('chat-log');
        const startView = document.getElementById('start-view');
        const mainContent = document.getElementById('main-content');
        const submitButton = document.getElementById('submit-button');

        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            sessionStorage.setItem('api_password', document.getElementById('password-input').value);
            passwordModal.close();
        });
        function checkPassword() { if (!sessionStorage.getItem('api_password')) passwordModal.showModal(); }
        window.addEventListener('load', checkPassword);

        document.querySelectorAll('input[name="mode"]').forEach(radio => {
            radio.addEventListener('change', (event) => {
                manualControls.hidden = event.target.value !== 'manual';
            });
        });

        function addMessage(sender, content, isHtml = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            const contentDiv = document.createElement('div');
            if (isHtml) {
                contentDiv.innerHTML = content;
            } else {
                contentDiv.textContent = content;
            }
            messageDiv.innerHTML = `<div class="message-header">${sender === 'user' ? 'Sie' : 'AI Agent'}</div>`;
            messageDiv.appendChild(contentDiv);
            chatLog.appendChild(messageDiv);
            mainContent.scrollTop = mainContent.scrollHeight;
            return contentDiv;
        }

        agentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            checkPassword();
            const password = sessionStorage.getItem('api_password');
            if (!password) return;

            const promptText = promptInput.value.trim();
            if (!promptText) return;

            if (chatLog.style.display === 'none') {
                startView.style.display = 'none';
                chatLog.style.display = 'block';
            }

            addMessage('user', promptText);
            const aiMessageContent = addMessage('ai', `<i>Agent plant die Anfrage...</i><span class="thinking-cursor"></span>`, true);

            promptInput.value = '';
            submitButton.setAttribute('aria-busy', 'true');

            const mode = document.querySelector('input[name="mode"]:checked').value;
            const payload = {
                prompt: promptText,
                mode: mode,
                output_format: document.getElementById('output_format').value,
                user_overrides: mode === 'manual' ? {
                    model: document.getElementById('model').value,
                    tools: { websuche: document.getElementById('websuche').checked, code_interpreter: document.getElementById('code-interpreter').checked }
                } : {}
            };
            
            const apiUrl = 'https://ai-agent-backend-hatu.onrender.com/generate';

            try {
                await new Promise(resolve => setTimeout(resolve, 1000));
                aiMessageContent.innerHTML = `<i>Führe die Anfrage aus...</i><span class="thinking-cursor"></span>`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${password}` },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    let errorTitle = `Fehler (${response.status})`, errorMessage = "Ein unerwarteter Server-Fehler.";
                    if (response.status === 401) {
                        sessionStorage.removeItem('api_password');
                        errorMessage = "Passwort war falsch. Bitte Seite neu laden und erneut eingeben.";
                    }
                    try {
                        const errorData = await response.json();
                        errorMessage += ` Details: ${errorData.details || 'Keine Details'}`;
                    } catch {}
                    throw new Error(`${errorTitle}|${errorMessage}`);
                }
                
                if (payload.output_format === 'powerpoint') {
                    aiMessageContent.innerHTML = `<p>✅ PowerPoint-Download wird gestartet.</p>`;
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = `praesentation.pptx`; a.click();
                    window.URL.revokeObjectURL(url);
                } else {
                    const data = await response.json();
                    let formattedResponse = data.responseText;
                    if (payload.output_format === 'code' || formattedResponse.includes("```")) {
                        formattedResponse = formattedResponse.replace(/```(\w+)?\n/g, '<pre><code>').replace(/```/g, '</code></pre>');
                    } else {
                        formattedResponse = `<p>${formattedResponse.replace(/\n/g, '<br>')}</p>`;
                    }
                    aiMessageContent.innerHTML = formattedResponse;
                }

            } catch (error) {
                const [title, message] = error.message.split('|');
                aiMessageContent.innerHTML = `<div class="error-message"><strong>${title}</strong><p>${message || "Ein Verbindungsfehler ist aufgetreten."}</p></div>`;
            } finally {
                submitButton.removeAttribute('aria-busy');
            }
        });
    </script>
</body>
</html>
