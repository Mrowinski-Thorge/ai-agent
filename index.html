<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal AI Agent</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        :root {
            --pico-font-size: 100%;
            --pico-line-height: 1.6;
            --pico-card-background-color: #242424;
            --pico-card-border-color: #333;
        }
        html, body {
            height: 100%;
            margin: 0;
            overflow: hidden; /* Verhindert Scrollen auf der Hauptebene */
        }
        body {
            display: flex;
            flex-direction: column;
            background-color: var(--pico-background-color);
        }
        header {
            text-align: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--pico-card-border-color);
        }
        header h1 { margin: 0; font-size: 1.5rem; }
        
        main {
            flex-grow: 1;
            overflow-y: auto; /* Scrollen nur im Chat-Bereich */
            padding: 1rem;
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 960px;
            margin: 0 auto;
        }

        /* Startansicht (wenn keine Nachrichten da sind) */
        #start-view {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            height: 100%;
        }
        #start-view h2 { color: var(--pico-h2-color); }
        #start-view p { color: var(--pico-muted-color); }

        /* Chat-Nachrichten */
        #chat-log {
            flex-grow: 1;
        }
        .chat-message {
            padding: 1.2rem;
            margin-bottom: 1rem;
            border-radius: var(--pico-border-radius);
            max-width: 95%;
        }
        .user-message {
            background-color: transparent;
            align-self: flex-end;
        }
        .ai-message {
            background-color: var(--pico-card-background-color);
            border: 1px solid var(--pico-card-border-color);
            align-self: flex-start;
        }
        .message-header {
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 0.9em;
            display: flex;
            align-items: center;
        }
        .message-header::before {
            content: 'üë§';
            margin-right: 0.5em;
            font-size: 1.2em;
        }
        .ai-message .message-header::before {
            content: 'ü§ñ';
        }
        .ai-message pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            background-color: #1a1a1a;
            padding: 1rem;
            border-radius: var(--pico-border-radius);
            font-size: 0.9em;
        }
        .thinking-cursor {
            display: inline-block;
            width: 10px;
            height: 1.2em;
            background-color: var(--pico-primary);
            animation: blink 1s step-end infinite;
            vertical-align: text-bottom;
        }
        @keyframes blink { from, to { background-color: transparent; } 50% { background-color: var(--pico-primary); } }
        
        .status-message {
            font-style: italic;
            color: var(--pico-muted-color);
            font-size: 0.9em;
        }

        /* Eingabebereich am unteren Rand */
        footer {
            padding: 1rem;
            width: 100%;
            max-width: 960px;
            margin: 0 auto;
        }
        #agent-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        #prompt-container {
            position: relative;
        }
        #prompt {
            width: 100%;
            padding-right: 60px; /* Platz f√ºr den Senden-Button */
            resize: none;
        }
        #submit-button {
            position: absolute;
            right: 10px;
            bottom: 10px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        /* Passwort-Modal */
        #password-modal.modal-open {
            display: flex;
        }
        #password-modal .modal-content {
            max-width: 400px;
        }
    </style>
</head>
<body>

    <!-- Passwort-Modal -->
    <dialog id="password-modal">
        <article class="modal-content">
            <header>
                <h3>Zugangspasswort ben√∂tigt</h3>
            </header>
            <form id="password-form">
                <label for="password-input">Bitte geben Sie das Passwort ein:</label>
                <input type="password" id="password-input" required>
                <button type="submit">Best√§tigen</button>
            </form>
        </article>
    </dialog>

    <header>
        <h1>Universal AI Agent</h1>
    </header>

    <main id="main-content">
        <div id="start-view">
            <h2>Wie kann ich Ihnen heute helfen?</h2>
            <p>Fragen Sie nach Code, einer Pr√§sentation oder lassen Sie den Agenten f√ºr Sie recherchieren.</p>
        </div>
        <div id="chat-log"></div>
    </main>

    <footer>
        <form id="agent-form">
            <div id="prompt-container">
                <textarea id="prompt" name="prompt" rows="1" placeholder="Ihre Anfrage..." required></textarea>
                <button type="submit" id="submit-button" aria-label="Senden">‚û§</button>
            </div>
            <div class="grid">
                <fieldset>
                    <legend style="padding: 0 0.5rem;">Modus</legend>
                    <label><input type="radio" name="mode" value="automatic" checked> Auto</label>
                    <label><input type="radio" name="mode" value="manual"> Manuell</label>
                </fieldset>
                <div>
                    <label for="output_format">Ausgabeformat</label>
                    <select id="output_format" name="output_format">
                        <option value="text" selected>Text</option>
                        <option value="powerpoint">PowerPoint</option>
                        <option value="code">Code</option>
                    </select>
                </div>
            </div>
        </form>
    </footer>

    <script>
        // --- DOM-Elemente ---
        const passwordModal = document.getElementById('password-modal');
        const passwordForm = document.getElementById('password-form');
        const agentForm = document.getElementById('agent-form');
        const promptInput = document.getElementById('prompt');
        const chatLog = document.getElementById('chat-log');
        const startView = document.getElementById('start-view');
        const mainContent = document.getElementById('main-content');

        // --- Passwort-Handling ---
        passwordForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('password-input').value;
            sessionStorage.setItem('api_password', password);
            passwordModal.close();
        });

        function checkPassword() {
            if (!sessionStorage.getItem('api_password')) {
                passwordModal.showModal();
            }
        }
        
        // --- UI-Helfer ---
        function addMessage(sender, content) {
            startView.hidden = true;
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            messageDiv.innerHTML = `<div class="message-header">${sender === 'user' ? 'Sie' : 'AI Agent'}</div>${content}`;
            chatLog.appendChild(messageDiv);
            mainContent.scrollTop = mainContent.scrollHeight;
            return messageDiv;
        }

        function displayError(title, message) {
            return `<div class="error-message"><strong>${title}</strong><p>${message}</p></div>`;
        }

        // --- Hauptlogik ---
        agentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            checkPassword();
            const password = sessionStorage.getItem('api_password');
            if (!password) return;

            const promptText = promptInput.value;
            if (!promptText.trim()) return;

            addMessage('user', `<p>${promptText}</p>`);
            const aiMessageDiv = addMessage('ai', `<p class="status-message">Agent plant die Anfrage...<span class="thinking-cursor"></span></p>`);

            promptInput.value = '';
            promptInput.disabled = true;

            const payload = {
                prompt: promptText,
                mode: document.querySelector('input[name="mode"]:checked').value,
                output_format: document.getElementById('output_format').value,
                user_overrides: { /* Manuelle Overrides werden in diesem einfachen UI nicht mehr explizit gesetzt, die Logik im Backend greift aber noch */ }
            };

            const apiUrl = 'https://ai-agent-backend-hatu.onrender.com/generate';

            try {
                // Simuliere den Planungsschritt f√ºr den Benutzer
                await new Promise(resolve => setTimeout(resolve, 1500));
                aiMessageDiv.querySelector('.status-message').innerHTML = `F√ºhre die Anfrage aus...<span class="thinking-cursor"></span>`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${password}` },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    let errorTitle = `Fehler (${response.status})`;
                    let errorMessage = "Ein unerwarteter Server-Fehler ist aufgetreten.";
                    if (response.status === 401) {
                        sessionStorage.removeItem('api_password'); // Passwort war falsch, also l√∂schen
                        errorTitle = "Authentifizierung fehlgeschlagen";
                        errorMessage = "Das Passwort war falsch. Es wurde zur√ºckgesetzt. Bitte laden Sie die Seite neu und geben Sie es erneut ein.";
                    } else if (response.status === 503 || response.status === 504) {
                        errorTitle = "Server ausgelastet oder im Kaltstart";
                        errorMessage = "Der Server braucht einen Moment. Bitte versuchen Sie es in 30 Sekunden erneut.";
                    }
                    throw new Error(`${errorTitle}|${errorMessage}`);
                }

                if (payload.output_format === 'powerpoint') {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `praesentation.pptx`;
                    a.click();
                    window.URL.revokeObjectURL(url);
                    aiMessageDiv.innerHTML = `<div class="message-header">AI Agent</div><p>‚úÖ PowerPoint-Download wurde gestartet.</p>`;
                } else {
                    const data = await response.json();
                    let formattedResponse = data.responseText;
                    // Wenn die Antwort Code enth√§lt, packen wir sie in <pre><code>
                    if (payload.output_format === 'code' || formattedResponse.includes("```")) {
                        formattedResponse = formattedResponse.replace(/```(\w+)?\n/g, '<pre><code>').replace(/```/g, '</code></pre>');
                    } else {
                        formattedResponse = `<p>${formattedResponse}</p>`;
                    }
                    aiMessageDiv.innerHTML = `<div class="message-header">AI Agent</div>${formattedResponse}`;
                }

            } catch (error) {
                const [title, message] = error.message.split('|');
                aiMessageDiv.innerHTML = `<div class="message-header">AI Agent</div>${displayError(title, message || "Ein Verbindungsfehler ist aufgetreten.")}`;
            } finally {
                promptInput.disabled = false;
                promptInput.focus();
            }
        });

        // Beim Start der Seite das Passwort pr√ºfen
        window.addEventListener('load', checkPassword);

        // Auto-Resize f√ºr das Textfeld
        promptInput.addEventListener('input', () => {
            promptInput.style.height = 'auto';
            promptInput.style.height = (promptInput.scrollHeight) + 'px';
        });

    </script>
</body>
</html>
